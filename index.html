<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cartographie – Formations</title>
  <style>
    :root{
      --bg:#e7e4df;
      --top:#3e3e40;
      --top2:#ffffff;
      --panel:#f7f7f7;
      --card:#ffffff;
      --text:#1f2a37;
      --muted:#6b7280;
      --border:#e5e7eb;

      --blue:#0b77c5;
      --blue2:#0a6ab0;
      --accent:#00a3e0;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== Header ===== */
    .topbar{
      height:70px;
      background: var(--top);
      display:flex;
      align-items:center;
      justify-content:flex-start; /* plus d'actions à droite */
      padding: 0 18px;
    }
    .brand{
      display:flex; align-items:center; gap:16px;
      min-width: 320px;
    }
    .brand img{
      height:34px;
      width:auto;
      display:block;
    }
    .brand .divider{
      width:1px; height:34px; background: rgba(255,255,255,.20);
    }

    /* ===== Subnav (Vue > Création) ===== */
    .subnav{
      height:46px;
      background: var(--top2);
      border-bottom:1px solid #dcdcdc;
      display:flex;
      align-items:center;
      gap:12px;
      padding: 0 18px;
      overflow:auto;
      white-space:nowrap;
    }
    .navlink{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:10px;
      font-weight:900;
      color:#2f3b4a;
      text-decoration:none;
      border:1px solid transparent;
      cursor:pointer;
      user-select:none;
    }
    .navlink:hover{ background:#f3f4f6; }
    .navlink.active{
      background: rgba(11,119,197,.08);
      border-color: rgba(11,119,197,.25);
      color: var(--blue);
    }
    .sep{
      color:#9aa3af;
      font-weight:900;
    }

    /* ===== App ===== */
    .app{
      display:grid;
      grid-template-columns: 1fr 440px;
      gap:16px;
      padding:16px;
      height: calc(100vh - 70px - 46px);
    }

    .canvasWrap{
      position:relative;
      border-radius:12px;
      overflow:hidden;
      min-height: 520px;
    }

    .toolbar{
      position:absolute;
      top:14px;
      left:14px;
      z-index:5;
      background: rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      max-width: calc(100% - 28px);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    label.small{
      font-size:12px;
      color: var(--muted);
      font-weight:900;
    }

    select, button, input{
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
      color: var(--text);
      outline:none;
      font-weight:700;
    }
    select:focus, input:focus{
      box-shadow: 0 0 0 3px rgba(11,119,197,.15);
      border-color: rgba(11,119,197,.35);
    }

    button{
      cursor:pointer;
      background: var(--blue);
      border-color: rgba(11,119,197,.25);
      color:#fff;
      transition:.12s;
      font-weight:900;
    }
    button:hover{ background: var(--blue2); }
    button.ghost{
      background:#fff;
      color: var(--text);
    }
    button.ghost:hover{ background:#f3f4f6; }
    button.warn{
      background: #fff;
      color:#8a5b00;
      border-color: rgba(255,206,86,.55);
    }
    button.warn:hover{ background:#fff7e6; }
    button.danger{
      background:#fff;
      color:#9b1230;
      border-color: rgba(255,77,109,.45);
    }
    button.danger:hover{ background:#ffe8ee; }

    /* Map */
    svg{
      width:100%;
      height:100%;
      display:block;
      background:#fff;
      border-radius:12px;
      border:1px solid #dcdcdc;
    }
    .zonePoly{
      fill: rgba(11,119,197,.18);
      stroke: rgba(11,119,197,.95);
      stroke-width: 2;
      cursor:pointer;
      transition:.12s;
    }
    .zonePoly:hover{ fill: rgba(11,119,197,.26); }
    .zonePoly.selected{
      fill: rgba(255,206,86,.25);
      stroke: rgba(255,152,0,.95);
    }
    .vertex{
      fill:#fff;
      stroke: rgba(0,0,0,.35);
      stroke-width:1;
      cursor:grab;
    }
    .vertex:hover{ fill: rgba(255,206,86,.95); }

    /* Right panel */
    .panel{
      background: var(--panel);
      border:1px solid #dcdcdc;
      border-radius:12px;
      padding:14px;
      overflow:auto;
    }

    /* Tabs (conservés) */
    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:14px;
    }
    .tabBtn{
      flex:1;
      border:1px solid var(--border);
      background:#fff;
      color: var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .tabBtn.active{
      background: rgba(11,119,197,.08);
      border-color: rgba(11,119,197,.35);
      box-shadow: 0 0 0 3px rgba(11,119,197,.10) inset;
      color: var(--blue);
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin:10px 0;
    }
    .title{
      font-weight:900;
      color: var(--blue);
      letter-spacing:.4px;
      font-size:18px;
      margin:0 0 8px;
      text-transform:uppercase;
    }
    .muted{ color: var(--muted); font-size:12px; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .stack{ display:flex; flex-direction:column; gap:10px; }
    .hr{ height:1px; background: #edf0f2; margin:12px 0; }

    .bar{ height:10px; border-radius:999px; background:#eef2f7; overflow:hidden; border:1px solid #e5e7eb; }
    .bar > div{ height:100%; width:0%; background: var(--accent); }

    .agentBox{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .badges{ display:flex; flex-wrap:wrap; gap:8px; }
    .badge{
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      display:inline-flex;
      gap:6px;
      align-items:center;
      background:#fff;
      font-weight:800;
    }
    .badge input{ transform: translateY(1px); }
    .metaLine{ display:flex; flex-wrap:wrap; gap:8px; }
    .metaChip{
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color: var(--muted);
      background:#fff;
      display:inline-flex;
      gap:6px;
      align-items:center;
      font-weight:700;
    }

    @media (max-width: 1100px){
      .app{ grid-template-columns: 1fr; height:auto; }
      .panel{ height:auto; }
    }
  </style>
</head>

<body>

  <!-- Header -->
  <header class="topbar">
    <div class="brand">
      <img src="sncf.png" alt="SNCF">
      <div class="divider"></div>
      <img src="formation.png" alt="FORMATION">
    </div>
  </header>

  <!-- Subnav -->
  <nav class="subnav">
    <div id="navVue" class="navlink active" role="button" tabindex="0">Vue</div>
    <span class="sep">›</span>
    <div id="navCreation" class="navlink" role="button" tabindex="0">Création</div>
  </nav>

  <!-- App -->
  <div class="app">
    <!-- Map -->
    <div class="canvasWrap">
      <div class="toolbar">
        <span class="pill">Mode : <b id="modeLabel">Vue</b></span>

        <label class="small">Formation</label>
        <select id="formationSelect">
          <option value="EPI">EPI</option>
          <option value="Extincteur">Extincteur</option>
          <option value="GF-SF">GF-SF</option>
        </select>

        <label class="small">Vacation</label>
        <select id="vacationFilter">
          <option value="ALL">Toutes</option>
          <option value="A">A</option>
          <option value="B">B</option>
        </select>

        <label class="small">Horaire</label>
        <select id="shiftFilter">
          <option value="ALL">Tous</option>
          <option value="4h - 12h">4h - 12h</option>
          <option value="7h45 - 16h30">7h45 - 16h30</option>
          <option value="20h - 4h">20h - 4h</option>
        </select>

        <button id="deselectBtn" class="ghost">Désélectionner</button>
      </div>

      <svg id="mapSvg" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid meet">
        <image id="planImage" href="Plan.jpg" x="0" y="0" width="1200" height="700" opacity="0.98"></image>
        <g id="zonesLayer"></g>
        <g id="editLayer"></g>
      </svg>
    </div>

    <!-- Right panel -->
    <aside class="panel">
      <div class="tabs">
        <button class="tabBtn active" id="tabView">Vue</button>
        <button class="tabBtn" id="tabCreate">Création</button>
      </div>

      <!-- VUE -->
      <section id="viewSection">
        <div class="card">
          <div class="title">MES ACTIONS EN ATTENTE</div>
          <div class="muted" id="loadStatusText">Initialisation…</div>
        </div>

        <div id="emptyView" class="card" style="display:none;">
          <div class="muted">Clique sur une zone du plan.</div>
        </div>

        <div id="viewPanel" style="display:none;">
          <div class="card">
            <div class="title">MES INFORMATIONS</div>

            <div class="row">
              <div>
                <div class="muted">Nom de la zone</div>
                <div id="v_zoneName" style="font-size:18px; font-weight:900;"></div>
              </div>
              <div style="text-align:right;">
                <div class="muted">Nombre d’agents</div>
                <div id="v_zoneCount" style="font-size:18px; font-weight:900;"></div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="muted">Progression formation (zone)</div>

            <div style="margin-top:10px;">
              <div class="row">
                <div>
                  <div style="font-weight:900;" id="v_totalLabel">Total</div>
                  <div class="muted" id="v_totalDetail"></div>
                </div>
                <div id="v_totalPct" style="font-size:16px; font-weight:900;"></div>
              </div>
              <div class="bar" style="margin-top:8px;"><div id="v_totalBar"></div></div>
            </div>

            <div style="margin-top:14px;">
              <div class="row">
                <div>
                  <div style="font-weight:900;" id="v_filteredLabel">Filtré</div>
                  <div class="muted" id="v_filteredDetail"></div>
                </div>
                <div id="v_filteredPct" style="font-size:16px; font-weight:900;"></div>
              </div>
              <div class="bar" style="margin-top:8px;"><div id="v_filteredBar"></div></div>
            </div>

            <div class="hr"></div>

            <div style="font-weight:900; margin-bottom:8px;">Agents</div>
            <div id="v_agentsList" class="stack"></div>
          </div>
        </div>
      </section>

      <!-- CREATION -->
      <section id="createSection" style="display:none;">
        <div class="card">
          <div class="title">CRÉATION</div>

          <div class="row">
            <div style="font-weight:900;">Zones</div>
            <button id="newZoneBtn">+ Nouvelle zone</button>
          </div>
          <div class="muted" style="margin-top:6px;">
            Pour créer/redessiner : clique sur la carte pour poser des points, puis Terminer.
          </div>

          <div class="hr"></div>

          <div class="stack">
            <label class="small">Zone sélectionnée</label>
            <select id="zoneSelect"></select>

            <label class="small">Nom de zone</label>
            <input id="zoneNameInput" placeholder="Ex: Atelier A" />

            <div class="row">
              <button id="startDrawBtn">Créer / redessiner polygone</button>
              <button id="finishDrawBtn" class="warn">Terminer</button>
            </div>

            <div class="row">
              <button id="deleteZoneBtn" class="danger">Supprimer zone</button>
              <button id="exportJsonBtn">Exporter en .json</button>
            </div>

            <div class="muted" id="drawState" style="margin-top:6px;"></div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <div style="font-weight:900;">Agents & formations</div>
            <button id="addAgentBtn">+ Ajouter agent</button>
          </div>
          <div class="muted" style="margin-top:6px;">
            Champs agent : <b>Nom</b>, <b>Plage horaire</b>, <b>Vacation</b>, + formations.
          </div>

          <div id="c_agentsEmpty" class="muted" style="margin-top:10px; display:none;">
            Sélectionne une zone pour éditer ses agents.
          </div>
          <div id="c_agentsList" class="stack" style="margin-top:10px;"></div>
        </div>
      </section>
    </aside>
  </div>

<script>
/* =========================
   Data
========================= */
const formations = ["GF-SF", "EPI", "Extincteur"];
const shifts = ["4h - 12h", "7h45 - 16h30", "20h - 4h"];
const vacations = ["A", "B"];

let state = { viewBox: "0 0 1200 700", zones: [] };

let activeTab = "view";
let selectedZoneId = null;

let isDrawing = false;
let draftPoints = [];

let draggingVertex = null;
let dragOffset = {x:0,y:0};

/* =========================
   DOM
========================= */
const mapSvg = document.getElementById("mapSvg");
const zonesLayer = document.getElementById("zonesLayer");
const editLayer = document.getElementById("editLayer");

const tabView = document.getElementById("tabView");
const tabCreate = document.getElementById("tabCreate");
const viewSection = document.getElementById("viewSection");
const createSection = document.getElementById("createSection");
const modeLabel = document.getElementById("modeLabel");

const navVue = document.getElementById("navVue");
const navCreation = document.getElementById("navCreation");

const formationSelect = document.getElementById("formationSelect");
const vacationFilter = document.getElementById("vacationFilter");
const shiftFilter = document.getElementById("shiftFilter");
const deselectBtn = document.getElementById("deselectBtn");

const loadStatusText = document.getElementById("loadStatusText");
const emptyView = document.getElementById("emptyView");
const viewPanel = document.getElementById("viewPanel");
const v_zoneName = document.getElementById("v_zoneName");
const v_zoneCount = document.getElementById("v_zoneCount");
const v_totalLabel = document.getElementById("v_totalLabel");
const v_totalDetail = document.getElementById("v_totalDetail");
const v_totalPct = document.getElementById("v_totalPct");
const v_totalBar = document.getElementById("v_totalBar");
const v_filteredLabel = document.getElementById("v_filteredLabel");
const v_filteredDetail = document.getElementById("v_filteredDetail");
const v_filteredPct = document.getElementById("v_filteredPct");
const v_filteredBar = document.getElementById("v_filteredBar");
const v_agentsList = document.getElementById("v_agentsList");

const zoneSelect = document.getElementById("zoneSelect");
const zoneNameInput = document.getElementById("zoneNameInput");
const newZoneBtn = document.getElementById("newZoneBtn");
const deleteZoneBtn = document.getElementById("deleteZoneBtn");
const exportJsonBtn = document.getElementById("exportJsonBtn");
const startDrawBtn = document.getElementById("startDrawBtn");
const finishDrawBtn = document.getElementById("finishDrawBtn");
const drawState = document.getElementById("drawState");

const addAgentBtn = document.getElementById("addAgentBtn");
const c_agentsEmpty = document.getElementById("c_agentsEmpty");
const c_agentsList = document.getElementById("c_agentsList");

/* =========================
   Load Zone.json
========================= */
async function loadZonesJson() {
  try {
    const res = await fetch("Zone.json?ts=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const zones = await res.json();
    if (!Array.isArray(zones)) throw new Error("Zone.json doit être un tableau []");

    state.zones = zones.map((z, i) => ({
      id: String(z.id || ("Z" + (i+1))),
      name: String(z.name || "(sans nom)"),
      points: String(z.points || ""),
      agents: Array.isArray(z.agents) ? z.agents.map(a => ({
        name: String(a.name || ""),
        shift: shifts.includes(a.shift) ? a.shift : shifts[1],
        vacation: vacations.includes(a.vacation) ? a.vacation : "A",
        trainings: normalizeTrainings(a.trainings || {})
      })) : []
    }));

    loadStatusText.textContent = `Zone.json chargé : ${state.zones.length} zone(s).`;
  } catch (e) {
    state.zones = [];
    loadStatusText.textContent = `Impossible de charger Zone.json (${e.message}).`;
  }

  selectedZoneId = state.zones.length ? state.zones[0].id : null;
  renderZones();
  syncZoneSelect();
  updatePanels();
}

/* =========================
   Tabs + Nav (Vue > Création)
========================= */
function setTab(tab){
  activeTab = tab;
  const isView = tab === "view";

  tabView.classList.toggle("active", isView);
  tabCreate.classList.toggle("active", !isView);

  navVue.classList.toggle("active", isView);
  navCreation.classList.toggle("active", !isView);

  viewSection.style.display = isView ? "block" : "none";
  createSection.style.display = isView ? "none" : "block";
  modeLabel.textContent = isView ? "Vue" : "Création";

  if(isView){
    stopDrawing(false);
    editLayer.innerHTML = "";
  } else {
    if(!selectedZoneId && state.zones.length) selectedZoneId = state.zones[0].id;
    syncZoneSelect();
  }

  renderZones();
  updatePanels();
}

tabView.addEventListener("click", ()=>setTab("view"));
tabCreate.addEventListener("click", ()=>setTab("create"));
navVue.addEventListener("click", ()=>setTab("view"));
navCreation.addEventListener("click", ()=>setTab("create"));

deselectBtn.addEventListener("click", ()=>{
  selectedZoneId = null;
  stopDrawing(false);
  renderZones();
  updatePanels();
});

formationSelect.addEventListener("change", updatePanels);
vacationFilter.addEventListener("change", updatePanels);
shiftFilter.addEventListener("change", updatePanels);

/* =========================
   Render zones
========================= */
function renderZones(){
  zonesLayer.innerHTML = "";
  editLayer.innerHTML = "";

  for(const z of state.zones){
    const poly = svgEl("polygon");
    poly.setAttribute("points", z.points || "");
    poly.setAttribute("class", "zonePoly" + (z.id === selectedZoneId ? " selected" : ""));
    poly.addEventListener("click", (e)=>{
      e.stopPropagation();
      selectedZoneId = z.id;
      if(activeTab === "create") syncZoneSelect();
      renderZones();
      updatePanels();
    });
    zonesLayer.appendChild(poly);
  }

  if(activeTab === "create" && selectedZoneId){
    const zone = getSelectedZone();
    if(zone && zone.points){
      const pts = parsePoints(zone.points);
      pts.forEach((p, idx)=>{
        const c = svgEl("circle");
        c.setAttribute("cx", p.x);
        c.setAttribute("cy", p.y);
        c.setAttribute("r", 7);
        c.setAttribute("class", "vertex");
        c.addEventListener("mousedown", (e)=>{
          e.stopPropagation();
          draggingVertex = { zoneId: zone.id, index: idx };
          const svgP = clientToSvg(e.clientX, e.clientY);
          dragOffset.x = svgP.x - p.x;
          dragOffset.y = svgP.y - p.y;
        });
        editLayer.appendChild(c);
      });
    }
  }

  if(activeTab === "create" && isDrawing){
    const pl = svgEl("polyline");
    pl.setAttribute("points", draftPoints.map(p=>`${p.x},${p.y}`).join(" "));
    pl.setAttribute("fill", "rgba(255,206,86,0.10)");
    pl.setAttribute("stroke", "rgba(255,152,0,0.95)");
    pl.setAttribute("stroke-width", "2");
    editLayer.appendChild(pl);

    draftPoints.forEach((p)=>{
      const c = svgEl("circle");
      c.setAttribute("cx", p.x);
      c.setAttribute("cy", p.y);
      c.setAttribute("r", 6);
      c.setAttribute("fill", "#fff");
      c.setAttribute("stroke", "rgba(0,0,0,.35)");
      c.setAttribute("stroke-width", "1");
      editLayer.appendChild(c);
    });
  }
}

/* =========================
   Stats
========================= */
function computeStats(agents, formation){
  const total = agents.length;
  const formed = agents.filter(a => !!(a.trainings && a.trainings[formation])).length;
  const pct = total === 0 ? 0 : Math.round((formed/total)*100);
  return { total, formed, pct };
}
function filterAgents(zoneAgents){
  const v = vacationFilter.value;
  const s = shiftFilter.value;
  return zoneAgents.filter(a=>{
    const okV = (v === "ALL") || (a.vacation === v);
    const okS = (s === "ALL") || (a.shift === s);
    return okV && okS;
  });
}

/* =========================
   View panel
========================= */
function updateViewPanel(){
  const zone = getSelectedZone();
  if(!zone){
    emptyView.style.display = "block";
    viewPanel.style.display = "none";
    return;
  }
  emptyView.style.display = "none";
  viewPanel.style.display = "block";

  const agents = zone.agents || [];
  v_zoneName.textContent = zone.name || "(sans nom)";
  v_zoneCount.textContent = agents.length;

  const formation = formationSelect.value;

  const totalStats = computeStats(agents, formation);
  v_totalLabel.textContent = `Total (${formation})`;
  v_totalPct.textContent = `${totalStats.pct}%`;
  v_totalBar.style.width = `${totalStats.pct}%`;
  v_totalDetail.textContent = `${totalStats.formed} / ${totalStats.total} agents formés`;

  const filteredAgents = filterAgents(agents);
  const filtStats = computeStats(filteredAgents, formation);
  const vacTxt = vacationFilter.value === "ALL" ? "toutes" : vacationFilter.value;
  const shiftTxt = shiftFilter.value === "ALL" ? "tous" : shiftFilter.value;

  v_filteredLabel.textContent = `Filtré (${formation})`;
  v_filteredPct.textContent = `${filtStats.pct}%`;
  v_filteredBar.style.width = `${filtStats.pct}%`;
  v_filteredDetail.textContent = `${filtStats.formed} / ${filtStats.total} — vacation ${vacTxt}, horaire ${shiftTxt}`;

  v_agentsList.innerHTML = "";
  agents.forEach(a=>{
    const box = document.createElement("div");
    box.className = "agentBox";

    const top = document.createElement("div");
    top.className = "row";
    top.innerHTML = `<div style="font-weight:900;">${escapeHtml(a.name)}</div><div class="muted">Vac ${escapeHtml(a.vacation || "-")}</div>`;
    box.appendChild(top);

    const meta = document.createElement("div");
    meta.className = "metaLine";
    meta.innerHTML = `
      <span class="metaChip"><b>Horaire</b> ${escapeHtml(a.shift || "-")}</span>
      <span class="metaChip"><b>Vacation</b> ${escapeHtml(a.vacation || "-")}</span>
    `;
    box.appendChild(meta);

    const badges = document.createElement("div");
    badges.className = "badges";
    formations.forEach(f=>{
      const ok = !!a.trainings?.[f];
      const b = document.createElement("div");
      b.className = "badge";
      b.textContent = `${f} • ${ok ? "OK" : "Non"}`;
      badges.appendChild(b);
    });
    box.appendChild(badges);

    v_agentsList.appendChild(box);
  });
}

/* =========================
   Creation
========================= */
function syncZoneSelect(){
  zoneSelect.innerHTML = "";

  state.zones.forEach(z=>{
    const opt = document.createElement("option");
    opt.value = z.id;
    opt.textContent = `${z.name || "(sans nom)"} — ${z.id}`;
    zoneSelect.appendChild(opt);
  });

  if(state.zones.length === 0){
    zoneNameInput.value = "";
    c_agentsList.innerHTML = "";
    c_agentsEmpty.style.display = "block";
    drawState.textContent = "Aucune zone. Clique sur “Nouvelle zone”.";
    return;
  }

  if(selectedZoneId){
    zoneSelect.value = selectedZoneId;
  } else {
    selectedZoneId = state.zones[0].id;
    zoneSelect.value = selectedZoneId;
  }
  updateCreationFields();
}

function updateCreationFields(){
  const zone = getSelectedZone();
  if(!zone){
    zoneNameInput.value = "";
    c_agentsList.innerHTML = "";
    c_agentsEmpty.style.display = "block";
    return;
  }
  c_agentsEmpty.style.display = "none";
  zoneNameInput.value = zone.name || "";
  renderAgentsEditor(zone);
  updateDrawStateText();
}

zoneSelect.addEventListener("change", ()=>{
  selectedZoneId = zoneSelect.value;
  stopDrawing(false);
  renderZones();
  updateCreationFields();
  updatePanels();
});

zoneNameInput.addEventListener("input", ()=>{
  const zone = getSelectedZone();
  if(!zone) return;
  zone.name = zoneNameInput.value.trim();
  syncZoneSelect();
  renderZones();
  updatePanels();
});

newZoneBtn.addEventListener("click", ()=>{
  const name = prompt("Nom de la nouvelle zone ?");
  if(!name) return;
  const id = "Z" + Math.random().toString(16).slice(2,7).toUpperCase();
  state.zones.push({ id, name: name.trim(), points:"", agents:[] });
  selectedZoneId = id;
  syncZoneSelect();
  renderZones();
  updatePanels();
});

deleteZoneBtn.addEventListener("click", ()=>{
  const zone = getSelectedZone();
  if(!zone) return;
  if(!confirm(`Supprimer la zone "${zone.name}" ?`)) return;
  state.zones = state.zones.filter(z=>z.id !== zone.id);
  selectedZoneId = state.zones.length ? state.zones[0].id : null;
  stopDrawing(false);
  renderZones();
  syncZoneSelect();
  updatePanels();
});

exportJsonBtn.addEventListener("click", ()=>{
  const exportZones = state.zones.map(z => ({
    id: z.id,
    name: z.name,
    points: z.points,
    agents: z.agents
  }));
  downloadJson(exportZones, "Zone.json");
});

/* Drawing */
startDrawBtn.addEventListener("click", ()=>{
  if(!selectedZoneId){ alert("Sélectionne une zone d’abord."); return; }
  isDrawing = true;
  draftPoints = [];
  updateDrawStateText();
  renderZones();
});
finishDrawBtn.addEventListener("click", ()=> stopDrawing(true));

function stopDrawing(apply){
  if(!isDrawing) return;
  const zone = getSelectedZone();
  if(apply){
    if(draftPoints.length < 3){
      alert("Il faut au moins 3 points pour un polygone.");
      return;
    }
    zone.points = draftPoints.map(p=>`${Math.round(p.x)},${Math.round(p.y)}`).join(" ");
  }
  isDrawing = false;
  draftPoints = [];
  updateDrawStateText();
  renderZones();
}
function updateDrawStateText(){
  if(activeTab !== "create"){ drawState.textContent = ""; return; }
  if(isDrawing){
    drawState.innerHTML = `Mode dessin : <b>${draftPoints.length}</b> points. Clique pour ajouter, puis <b>Terminer</b>.`;
  } else {
    drawState.textContent = selectedZoneId ? "Tu peux déplacer les points du polygone en les glissant." : "Aucune zone sélectionnée.";
  }
}

mapSvg.addEventListener("click", (e)=>{
  if(activeTab !== "create" || !isDrawing) return;
  const p = clientToSvg(e.clientX, e.clientY);
  draftPoints.push({ x: p.x, y: p.y });
  renderZones();
  updateDrawStateText();
});

/* Vertex drag */
window.addEventListener("mousemove", (e)=>{
  if(activeTab !== "create" || !draggingVertex) return;
  const zone = state.zones.find(z=>z.id === draggingVertex.zoneId);
  if(!zone) return;

  const pts = parsePoints(zone.points);
  const p = clientToSvg(e.clientX, e.clientY);
  const idx = draggingVertex.index;

  pts[idx] = { x: p.x - dragOffset.x, y: p.y - dragOffset.y };
  zone.points = pts.map(pp=>`${Math.round(pp.x)},${Math.round(pp.y)}`).join(" ");
  renderZones();
  updatePanels();
});
window.addEventListener("mouseup", ()=>{
  if(!draggingVertex) return;
  draggingVertex = null;
  renderZones();
});

/* Agents */
addAgentBtn.addEventListener("click", ()=>{
  const zone = getSelectedZone();
  if(!zone){ alert("Sélectionne une zone."); return; }
  const name = prompt("Nom de l’agent ?");
  if(!name) return;

  zone.agents = zone.agents || [];
  zone.agents.push({
    name: name.trim(),
    shift: shifts[1],
    vacation: "A",
    trainings: normalizeTrainings({})
  });
  renderAgentsEditor(zone);
  updatePanels();
});

function renderAgentsEditor(zone){
  c_agentsList.innerHTML = "";
  (zone.agents || []).forEach((agent, idx)=>{
    const box = document.createElement("div");
    box.className = "agentBox";

    const top = document.createElement("div");
    top.className = "row";
    top.innerHTML = `
      <div style="font-weight:900;">${escapeHtml(agent.name || "")}</div>
      <button class="danger" data-remove="${idx}" style="padding:6px 10px;border-radius:10px;">Supprimer</button>
    `;
    box.appendChild(top);

    const nameRow = document.createElement("div");
    nameRow.className = "row";
    nameRow.innerHTML = `
      <div class="muted">Nom</div>
      <input value="${escapeAttr(agent.name || "")}" data-name-input="${idx}" style="width:60%;"/>
    `;
    box.appendChild(nameRow);

    const shiftRow = document.createElement("div");
    shiftRow.className = "row";
    shiftRow.innerHTML = `
      <div class="muted">Horaire</div>
      <select data-shift-select="${idx}" style="width:60%;">
        ${shifts.map(s => `<option value="${escapeAttr(s)}" ${agent.shift===s?"selected":""}>${escapeHtml(s)}</option>`).join("")}
      </select>
    `;
    box.appendChild(shiftRow);

    const vacRow = document.createElement("div");
    vacRow.className = "row";
    vacRow.innerHTML = `
      <div class="muted">Vacation</div>
      <select data-vac-select="${idx}" style="width:60%;">
        ${["A","B"].map(v => `<option value="${v}" ${agent.vacation===v?"selected":""}>${v}</option>`).join("")}
      </select>
    `;
    box.appendChild(vacRow);

    const badges = document.createElement("div");
    badges.className = "badges";
    formations.forEach(f=>{
      const checked = agent.trainings?.[f] ? "checked" : "";
      const lab = document.createElement("label");
      lab.className = "badge";
      lab.innerHTML = `
        <input type="checkbox" data-agent="${idx}" data-formation="${f}" ${checked}/>
        <span>${f}</span>
      `;
      badges.appendChild(lab);
    });
    box.appendChild(badges);

    c_agentsList.appendChild(box);
  });

  c_agentsList.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener("change", (e)=>{
      const zone = getSelectedZone();
      const idx = Number(e.target.dataset.agent);
      const f = e.target.dataset.formation;
      zone.agents[idx].trainings[f] = e.target.checked;
      updatePanels();
    });
  });
  c_agentsList.querySelectorAll('input[data-name-input]').forEach(inp=>{
    inp.addEventListener("input", (e)=>{
      const zone = getSelectedZone();
      const idx = Number(e.target.dataset.nameInput);
      zone.agents[idx].name = e.target.value;
      updatePanels();
    });
  });
  c_agentsList.querySelectorAll('select[data-shift-select]').forEach(sel=>{
    sel.addEventListener("change", (e)=>{
      const zone = getSelectedZone();
      const idx = Number(e.target.dataset.shiftSelect);
      zone.agents[idx].shift = e.target.value;
      updatePanels();
    });
  });
  c_agentsList.querySelectorAll('select[data-vac-select]').forEach(sel=>{
    sel.addEventListener("change", (e)=>{
      const zone = getSelectedZone();
      const idx = Number(e.target.dataset.vacSelect);
      zone.agents[idx].vacation = e.target.value;
      updatePanels();
    });
  });
  c_agentsList.querySelectorAll('button[data-remove]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const zone = getSelectedZone();
      const idx = Number(btn.dataset.remove);
      zone.agents.splice(idx,1);
      renderAgentsEditor(zone);
      updatePanels();
    });
  });
}

/* Panels */
function updatePanels(){
  updateViewPanel();
  if(activeTab === "create") updateCreationFields();
}

/* Helpers */
function getSelectedZone(){ return state.zones.find(z=>z.id === selectedZoneId) || null; }
function svgEl(tag){ return document.createElementNS("http://www.w3.org/2000/svg", tag); }

function parsePoints(pointsStr){
  if(!pointsStr) return [];
  return pointsStr.trim().split(/\s+/).map(pair=>{
    const [x,y] = pair.split(",").map(Number);
    return { x, y };
  }).filter(p => Number.isFinite(p.x) && Number.isFinite(p.y));
}
function clientToSvg(clientX, clientY){
  const pt = mapSvg.createSVGPoint();
  pt.x = clientX; pt.y = clientY;
  const ctm = mapSvg.getScreenCTM();
  if(!ctm) return {x:0,y:0};
  const inv = ctm.inverse();
  const svgP = pt.matrixTransform(inv);
  return { x: svgP.x, y: svgP.y };
}

function normalizeTrainings(t){
  const obj = {};
  for(const f of formations) obj[f] = !!t[f];
  return obj;
}
function downloadJson(data, filename){
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
function escapeAttr(str){ return String(str ?? "").replace(/"/g, "&quot;"); }

/* Init */
function init(){
  setTab("view");
  emptyView.style.display = "block";
  viewPanel.style.display = "none";
  loadZonesJson();
}
init();
</script>
</body>
</html>
